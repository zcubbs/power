version: '3'

tasks:
  ############################################################
  default:
    desc: Run Build
    cmds:
      - task: web
      - task: server
      - task: cli

  ############################################################
  web:
    desc: Build Web App
    dir: web/start
    cmds:
      - npm install
      - npm run build

  ############################################################
  server:
    desc: Build Server
    cmds:
      - go build -o bin/server ./cmd/server/main.go

  ############################################################
  cli:
    desc: Build CLI
    cmds:
      - go build -o bin/cli ./cmd/cli/main.go

  ############################################################
  plugins:
    desc: Build Plugins
    cmds:
      - task: plugins:go:apiserver:{{OS}}

  ############################################################
  plugins:go:apiserver:windows:
    desc: Build Plugins for Windows
    cmds:
      - >
        docker build \
          --build-arg SOURCE_DIR=plugins/go/apiserver \
          -t go-plugin-builder \
          -f build/Dockerfile.pluginbuild \
          .
      - >
        docker run --name temp-plugin-container go-plugin-builder
      - >
        docker cp temp-plugin-container:/app/plugin.so ./plugins/go/apiserver
      - >
        docker rm temp-plugin-container
  ############################################################
  plugins:go:apiserver:linux:
    desc: Build Plugins for Linux
    cmds:
      - cmd: go build -buildmode=plugin -o plugins/bin/apiserver.so ./plugins/go/apiserver/
        dir: .
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 1
          CC: x86_64-linux-gnu-gcc
